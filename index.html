<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>é«˜é›…äººç”Ÿæ¨¡æ‹Ÿå™¨ v4.0 ç»ˆæä¿®å¤ç‰ˆ</title>
    <style>
        :root {
            --bg-color: #f0f2f5;
            --card-bg: #ffffff;
            --primary: #2c3e50;
            --text-main: #333;
            --accent: #d35400;
        }

        body {
            font-family: 'Helvetica Neue', Helvetica, 'PingFang SC', 'Microsoft YaHei', Arial, sans-serif;
            background-color: var(--bg-color);
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            color: var(--text-main);
            transition: all 1s ease;
            overflow: hidden;
            user-select: none;
        }

        /* --- è§†è§‰ç‰¹æ•ˆå±‚ --- */
        #vfx-layer {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; z-index: 1; opacity: 0;
            transition: opacity 1s;
        }

        /* æ¨¡å¼ç‰¹æ•ˆè®¾å®š */
        body.mode-xiuxian { --bg-color: #e0f7fa; --primary: #006064; font-family: "KaiTi", serif; }
        body.mode-xiuxian #vfx-layer { background: radial-gradient(circle, rgba(255,215,0,0.1) 0%, transparent 70%); opacity: 1; }
        
        body.mode-dating { --bg-color: #fff0f5; --primary: #e91e63; }
        body.mode-dating #vfx-layer { background-image: radial-gradient(#ff69b4 1px, transparent 1px); background-size: 20px 20px; opacity: 0.6; }

        body.mode-horror { --bg-color: #050505; --primary: #fff; --card-bg: #1a1a1a; --text-main: #ccc; }
        body.mode-horror #vfx-layer { box-shadow: inset 0 0 100px #000; opacity: 1; animation: flicker 0.15s infinite; background: rgba(255,0,0,0.05); }
        
        body.mode-cthulhu { --bg-color: #1a0f1f; --primary: #4a148c; --card-bg: #221a25; --text-main: #9e9e9e; }
        body.mode-cthulhu .container { animation: breathe 4s infinite ease-in-out; filter: contrast(1.1); }
        
        body.mode-fantasy { --bg-color: #f9fbe7; --primary: #33691e; }
        
        @keyframes flicker { 0% { opacity: 0.8; } 50% { opacity: 1; } 100% { opacity: 0.8; } }
        @keyframes breathe { 0% { transform: scale(1); } 50% { transform: scale(1.02); } 100% { transform: scale(1); } }

        .container {
            width: 95%; max-width: 500px;
            background: var(--card-bg);
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            display: flex; flex-direction: column;
            height: 90vh; position: relative; z-index: 2;
            transition: all 0.5s;
        }

        .header {
            background: var(--primary); color: white; padding: 15px;
            text-align: center; font-weight: bold; display: flex;
            justify-content: center; gap: 10px; z-index: 10;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            font-size: 1.1rem; flex-shrink: 0;
        }

        .screen { padding: 20px; flex: 1; display: none; flex-direction: column; overflow-y: auto; position: relative; }
        .screen.active { display: flex; }

        /* UIç»„ä»¶ */
        .main-btn { width: 100%; padding: 15px; background: var(--primary); color: white; border: none; border-radius: 50px; font-size: 1rem; margin-top: 20px; font-weight: bold; cursor: pointer; }
        
        .stat-row { display: flex; align-items: center; margin-bottom: 15px; gap: 10px; }
        input[type=range] { flex: 1; accent-color: var(--primary); height: 20px; }
        
        .choice-group { display: flex; gap: 10px; margin-bottom: 20px; }
        .gender-btn { flex: 1; padding: 10px; border: 1px solid #ddd; background: #fff; border-radius: 8px; cursor: pointer; font-weight: bold; }
        .gender-btn.selected { background: var(--primary); color: white; border-color: var(--primary); }

        /* æ—¥å¿—åŒºåŸŸ */
        #log-container { flex: 1; overflow-y: auto; padding-bottom: 160px; scroll-behavior: smooth; }
        .log-item { padding: 8px 0; border-bottom: 1px dashed rgba(0,0,0,0.05); font-size: 0.95rem; line-height: 1.5; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        
        .age-tag { background: var(--primary); color: white; padding: 2px 6px; border-radius: 4px; font-size: 0.75rem; margin-right: 8px; font-weight: bold; display: inline-block; min-width: 32px; text-align: center; }

        /* äº’åŠ¨åŒºåŸŸ */
        #interaction-area {
            position: absolute; bottom: 0; left: 0; width: 100%;
            background: rgba(255,255,255,0.98); border-top: 1px solid #ddd;
            padding: 15px; box-sizing: border-box; 
            display: none; flex-direction: column; gap: 10px; z-index: 20;
            box-shadow: 0 -5px 20px rgba(0,0,0,0.1);
        }
        body.mode-horror #interaction-area { background: #222; border-color: #444; }
        
        .action-btn {
            background: var(--card-bg); border: 2px solid var(--primary); color: var(--text-main);
            padding: 12px; border-radius: 8px; font-weight: bold; text-align: left; cursor: pointer;
            transition: 0.2s;
        }
        .action-btn:active { transform: scale(0.98); }

        /* å¼¹çª— */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); z-index: 100;
            display: none; justify-content: center; align-items: center;
        }
        .modal-box {
            background: white; padding: 25px; border-radius: 12px; width: 80%; max-width: 300px;
            text-align: center; border: 3px solid #c0392b; animation: popIn 0.3s;
        }
        @keyframes popIn { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        /* ç‰¹æ®Šå­—ä½“ä¸é¢œè‰² */
        .txt-xiuxian { color: #00695c; font-weight: bold; }
        .txt-dating { color: #d81b60; font-style: italic; }
        .txt-horror { color: #c0392b; font-family: monospace; letter-spacing: -0.5px; }
        .txt-cthulhu { color: #8e24aa; font-family: monospace; text-shadow: 1px 1px 0 #000; }
        .highlight { background: rgba(255, 235, 59, 0.4); padding: 0 4px; border-radius: 2px; }
        .die-msg { background: #c0392b; color: white; padding: 5px; border-radius: 4px; display: block; text-align: center; margin-top: 5px; }
    </style>
</head>
<body>

<div id="vfx-layer"></div>

<div class="container">
    <div class="header">
        <span>ğŸ§</span> <span id="header-title">é«˜é›…äººç”Ÿæ¨¡æ‹Ÿå™¨</span> <span>ğŸ·</span>
    </div>

    <div id="screen-start" class="screen active" style="text-align: center;">
        <div style="font-size: 70px; margin: 40px 0;">ğŸ²</div>
        <h1>äººç”Ÿé‡å¼€ v4.0</h1>
        <p style="color: #666; margin-bottom: 20px; font-size: 0.9rem;">
            ä¿®ä»™ Â· ä¹™æ¸¸ Â· æ€ªè°ˆ Â· å…‹è‹é² Â· ç„å¹»
        </p>
        
        <div style="background: #ffebee; border-left: 5px solid #c62828; padding: 15px; text-align: left; margin: 20px 0; border-radius: 8px;">
            <strong style="color:#c62828">âš ï¸ æ…å…¥è­¦å‘Šï¼š</strong><br>
            <span style="font-size:0.85rem; color:#555">
            æœ¬ä½œå«â€œä¸–ç•Œçº¿å˜åŠ¨â€ç³»ç»Ÿã€‚<br>
            æ£€æµ‹åˆ°<span style="font-weight:bold">å¾®æ/ç²¾ç¥æ±¡æŸ“</span>å†…å®¹æ—¶ä¼šå¼¹å‡ºè¯¢é—®ã€‚<br>
            å¿ƒè„ç—…æˆ–èƒ†å°è€…è¯·åœ¨å¼¹çª—æ—¶é€‰æ‹©â€œæ‹’ç»â€ã€‚
            </span>
        </div>

        <button class="main-btn" onclick="goToSetup()">å¼€å§‹æŠ½å¡</button>
    </div>

    <div id="screen-setup" class="screen">
        <h2 style="text-align:center">åˆ†é…å¤©èµ‹ (20ç‚¹)</h2>
        <div class="choice-group">
            <button class="gender-btn selected" onclick="selectGender('ç”·', this)">ç”·</button>
            <button class="gender-btn" onclick="selectGender('å¥³', this)">å¥³</button>
            <button class="gender-btn" onclick="selectGender('???', this)">???</button>
        </div>
        
        <div style="text-align:center; margin-bottom:15px; font-weight:bold; color:var(--accent)">
            å‰©ä½™ç‚¹æ•°: <span id="points">20</span>
        </div>

        <div id="sliders"></div>

        <button class="main-btn" onclick="startGame()">å¯åŠ¨äººç”Ÿ</button>
    </div>

    <div id="screen-game" class="screen">
        <div id="log-container"></div>
        
        <div id="interaction-area"></div>
        
        <div id="restart-area" style="display:none; padding:10px; position: absolute; bottom: 20px; left: 0; width: 100%; box-sizing: border-box;">
            <button class="main-btn" onclick="resetGame()">å†æ¬¡é‡å¼€</button>
        </div>
    </div>
</div>

<div id="warning-modal" class="modal-overlay">
    <div class="modal-box">
        <h3 style="color:#c0392b; margin-top:0">âš ï¸ å‰æ–¹é«˜èƒ½</h3>
        <p id="warning-text" style="font-size:0.9rem; line-height:1.5; margin: 20px 0;">
            æ£€æµ‹åˆ°ä¸–ç•Œçº¿å‰§çƒˆæ³¢åŠ¨...
        </p>
        <div style="display: flex; gap: 10px;">
            <button class="gender-btn" onclick="resolveWarning(false)">æˆ‘æ€‚äº†</button>
            <button class="gender-btn" style="background:#c0392b; color:white; border:none" onclick="resolveWarning(true)">æå¿«ç‚¹</button>
        </div>
    </div>
</div>

<script>
    // --- æ¸¸æˆæ•°æ®é…ç½® ---
    const STATS_CFG = [
        {k:'face', n:'é¢œå€¼'}, {k:'iq', n:'æ™ºå•†'}, {k:'body', n:'ä½“è´¨'}, {k:'money', n:'å®¶å¢ƒ'}, {k:'luck', n:'æ°”è¿'}
    ];
    
    // çŠ¶æ€å˜é‡
    let stats = { face:0, iq:0, body:0, money:0, luck:0 };
    let points = 20;
    let gender = 'ç”·';
    let species = 'äººç±»';
    
    let age = 0;
    let isDead = false;
    let currentMode = 'normal';
    let gameTimer = null;
    let skipCounter = 0;
    let pendingMode = null; // å¾…ç¡®è®¤çš„æ¨¡å¼

    // DOMå¼•ç”¨
    const dom = {
        screens: document.querySelectorAll('.screen'),
        sliders: document.getElementById('sliders'),
        points: document.getElementById('points'),
        log: document.getElementById('log-container'),
        interaction: document.getElementById('interaction-area'),
        restart: document.getElementById('restart-area'),
        headerTitle: document.getElementById('header-title'),
        modal: document.getElementById('warning-modal'),
        warningText: document.getElementById('warning-text')
    };

    // --- åˆå§‹åŒ– ---
    function init() {
        dom.sliders.innerHTML = STATS_CFG.map(s => `
            <div class="stat-row">
                <span style="width:40px; font-weight:bold">${s.n}</span>
                <input type="range" min="0" max="10" value="0" data-key="${s.k}" oninput="updatePoint('${s.k}', this.value)">
                <span id="val-${s.k}" style="width:25px; text-align:right">0</span>
            </div>
        `).join('');
    }

    // --- UI æ“ä½œ ---
    function switchScreen(id) {
        dom.screens.forEach(s => s.classList.remove('active'));
        document.getElementById(id).classList.add('active');
    }

    function goToSetup() { switchScreen('screen-setup'); }

    function selectGender(g, btn) {
        gender = g;
        document.querySelectorAll('.gender-btn').forEach(b => b.classList.remove('selected'));
        btn.classList.add('selected');
    }

    function updatePoint(key, val) {
        val = parseInt(val);
        let used = 0;
        document.querySelectorAll('input[type=range]').forEach(i => {
            if (i.dataset.key !== key) used += parseInt(i.value);
        });

        if (used + val > 20) val = 20 - used;
        
        document.querySelector(`input[data-key="${key}"]`).value = val;
        document.getElementById(`val-${key}`).innerText = val;
        stats[key] = val;
        points = 20 - (used + val);
        dom.points.innerText = points;
        dom.points.style.color = points === 0 ? '#27ae60' : '#d35400';
    }

    // --- æ ¸å¿ƒé€»è¾‘ ---
    function startGame() {
        if (points > 0) { alert("å±æ€§ç‚¹æ²¡åˆ†å®Œï¼åšäººè¦å…¨åŠ›ä»¥èµ´ï¼"); return; }
        
        // é‡ç½®æ‰€æœ‰çŠ¶æ€
        age = -1; 
        isDead = false; 
        currentMode = 'normal'; 
        skipCounter = 0;
        document.body.className = '';
        dom.log.innerHTML = '';
        dom.interaction.style.display = 'none';
        dom.restart.style.display = 'none';
        dom.headerTitle.innerText = "é«˜é›…äººç”Ÿæ¨¡æ‹Ÿå™¨";

        // ç‰©ç§åˆ¤å®š
        if (gender === '???') {
            const list = ['é«˜é›…ä¼é¹…', 'èµ›åšèŸ‘è‚', 'æ·±æµ·ç« é±¼', 'ä¸€æ£µæ ‘', 'å²è±å§†'];
            species = list[Math.floor(Math.random() * list.length)];
        } else {
            species = 'äººç±»';
        }

        switchScreen('screen-game');
        addLog(`<strong>ç³»ç»Ÿå¯åŠ¨</strong> | èº«ä»½: ${species}`, 'normal');
        
        gameLoop();
    }

    function gameLoop() {
        if (isDead) return;
        gameTimer = setTimeout(processYear, 800); // 0.8ç§’ä¸€è·³
    }

    function processYear() {
        // 1. å¹´é¾„å¢é•¿ (ä¿®ä»™æ¨¡å¼é£é€)
        let inc = 1;
        if (currentMode === 'xiuxian') {
            if (age > 20) inc = Math.floor(Math.random() * 10) + 5;
            if (age > 200) inc = 50;
        }
        age += inc;

        // 2. æ­»äº¡åˆ¤å®š
        if (checkDeath()) return;

        // 3. å°è¯•è§¦å‘ä¸–ç•Œçº¿ (ä»…äººç±»æ™®é€šæ¨¡å¼)
        if (currentMode === 'normal' && species === 'äººç±»' && age > 6 && Math.random() < 0.15) {
            triggerWorldChange();
            return; // æš‚åœç­‰å¾…ç”¨æˆ·ç¡®è®¤
        }

        // 4. ç”Ÿæˆå†…å®¹
        let evt = generateEvent();

        // 5. æ™ºèƒ½è·³è¿‡é€»è¾‘
        if (!evt) {
            skipCounter += inc;
            gameLoop(); // ç›´æ¥ä¸‹ä¸€è½®ï¼Œä¸æ˜¾ç¤º
        } else {
            if (skipCounter > 0) {
                addLog(`...æ—¶å…‰é£é€ï¼Œè½¬çœ¼ ${skipCounter} å¹´è¿‡å»äº†...`, currentMode);
                skipCounter = 0;
            }
            addLog(evt.text, currentMode, evt.highlight);
            
            if (evt.choices) {
                showInteraction(evt.choices);
            } else {
                gameLoop();
            }
        }
    }

    // --- ä¸–ç•Œçº¿å˜åŠ¨ä¸è­¦å‘Š ---
    function triggerWorldChange() {
        const r = Math.random();
        let m = '', t = '', scary = false;

        if (r < 0.25 && (stats.iq > 7 || stats.body > 7)) {
            m = 'xiuxian'; t = "ä½ åœ¨åœ°æ‘Šä¸Šçœ‹åˆ°ä¸€æœ¬å‘å…‰çš„ã€Šå¹¿æ’­ä½“æ“ã€‹ï¼Œä¼¼ä¹æ˜¯å¤±ä¼ çš„ä¿®ä»™ç§˜ç±ã€‚";
        } else if (r < 0.5 && (stats.face > 7 || stats.luck > 8)) {
            m = 'dating'; t = "è½¬è§’æ’åˆ°äº†ä¸€ä¸ªå¼ç€é¢åŒ…çš„ç¾å°‘å¥³/å°‘å¹´ï¼Œä¸–ç•Œç”»é£çªç„¶å˜æˆäº†ç²‰è‰²ã€‚";
        } else if (r < 0.65) {
            m = 'fantasy'; t = "ä½ æ‰“å¼€è¡£æŸœï¼Œå‘ç°åé¢é€šå‘ä¸€ä¸ªå……æ»¡é­”æ³•ä¸å·¨é¾™çš„ä¸–ç•Œã€‚";
        } else if (r < 0.85) {
            m = 'horror'; t = "å‘¨å›´å˜å¾—æ­»ä¸€èˆ¬å¯‚é™ï¼Œé•œå­é‡Œçš„ä½ æ²¡æœ‰è·Ÿç€åŠ¨... (å¾®æè­¦å‘Š)"; scary = true;
        } else {
            m = 'cthulhu'; t = "å¤©ä¸Šçš„æœˆäº®å˜æˆäº†è •åŠ¨çš„çœ¼çƒï¼Œä½ çš„SANå€¼å¼€å§‹ç‹‚æ‰... (ç²¾ç¥æ±¡æŸ“)"; scary = true;
        }

        if (!m) { gameLoop(); return; }

        pendingMode = m;
        if (scary) {
            dom.warningText.innerHTML = `${t}<br><br><strong>æ˜¯å¦è¿›å…¥è¯¥ä¸–ç•Œçº¿ï¼Ÿ</strong>`;
            dom.modal.style.display = 'flex';
        } else {
            applyMode(m);
        }
    }

    function resolveWarning(accepted) {
        dom.modal.style.display = 'none';
        if (accepted) {
            applyMode(pendingMode);
        } else {
            addLog("ä½ æ„Ÿåˆ°ä¸€é˜µæ¶å¯’ï¼Œå†³å®šå…³ä¸Šé—¨å›å®¶ç¡è§‰ï¼Œæ‹’ç»äº†å‘½è¿çš„å¬å”¤ã€‚", 'normal');
            gameLoop();
        }
    }

    function applyMode(m) {
        currentMode = m;
        document.body.className = `mode-${m}`;
        
        let title = "é«˜é›…æ¨¡æ‹Ÿå™¨";
        if (m === 'xiuxian') title = "ä¿®ä»™æ¨¡æ‹Ÿå™¨ (ç‚¼æ°”æœŸ)";
        if (m === 'dating') title = "æ‹çˆ±å…»æˆæ¨¡æ‹Ÿå™¨";
        if (m === 'horror') title = "è§„åˆ™æ€ªè°ˆæ¨¡æ‹Ÿå™¨";
        if (m === 'cthulhu') title = "å…‹è‹é²çš„å‘¼å”¤";
        if (m === 'fantasy') title = "å¼‚ç•Œå†’é™©ä¼ ";
        dom.headerTitle.innerText = title;

        addLog(`>>> <strong>ä¸–ç•Œçº¿å˜åŠ¨ï¼è¿›å…¥ã€${title}ã€‘</strong> <<<`, m, true);
        setTimeout(gameLoop, 1000);
    }

    // --- äº‹ä»¶ç”Ÿæˆå¼•æ“ ---
    function generateEvent() {
        // ç‰©ç§äº‹ä»¶
        if (currentMode === 'normal' && species !== 'äººç±»') {
            return Math.random() < 0.3 ? { text: getSpeciesText() } : null;
        }

        // æ¨¡å¼äº‹ä»¶
        if (currentMode === 'xiuxian') return getXiuxianEvt();
        if (currentMode === 'dating') return getDatingEvt();
        if (currentMode === 'horror') return getHorrorEvt();
        if (currentMode === 'cthulhu') return getCthulhuEvt();
        if (currentMode === 'fantasy') return getFantasyEvt();

        // æ™®é€šäººç±»
        if (Math.random() < 0.3) {
            const list = ["æ²‰è¿·çŸ­è§†é¢‘ï¼Œè§†åŠ›ä¸‹é™ã€‚", "è·¯è¾¹æ¡åˆ°5å—é’±ã€‚", "è¯•å›¾å€’ç«‹æ´—å¤´å¤±è´¥ã€‚", "å­¦ç‹—å«è¢«é‚»å±…æŠ•è¯‰ã€‚", "åšäº†ä¸€é¡¿é»‘æš—æ–™ç†ã€‚", "å¹³å¹³æ·¡æ·¡çš„ä¸€å¹´ã€‚"];
            return { text: list[Math.floor(Math.random() * list.length)] };
        }
        return null;
    }

    // --- å„æ¨¡å¼å‰§æœ¬åº“ (v4.0 ç‰¹ä¾›) ---
    function getXiuxianEvt() {
        if (Math.random() < 0.1) {
            return {
                text: "ä½ åœ¨ç§˜å¢ƒä¸­å‘ç°ä¸€æ ªã€ä¸ƒå½©ç‰ç’ƒè‰ã€‘ï¼Œå®ˆæŠ¤å…½æ­£åœ¨ç¡è§‰ã€‚",
                highlight: true,
                choices: [
                    { t:"å·äº†å°±è·‘", f:()=>{ 
                        if(stats.luck>6) res("è¿æ°”çˆ†æ£šï¼ŒæˆåŠŸå·èµ°ä»™è‰ï¼Œä¿®ä¸ºå¤§æ¶¨ï¼", {iq:5});
                        else die("å®ˆæŠ¤å…½é†’äº†ï¼ŒæŠŠä½ å½“æˆäº†ç‚¹å¿ƒã€‚");
                    }},
                    { t:"æ­£é¢ç¡¬åˆš", f:()=>{
                         if(stats.body>8) res("ä½ ä¸€æ‹³æ‰“çˆ†äº†å®ˆæŠ¤å…½ï¼Œéœ‡æƒŠç™¾é‡Œã€‚", {body:5});
                         else die("ä½ é«˜ä¼°äº†è‡ªå·±çš„å®åŠ›ï¼Œè¢«æ‹æˆäº†è‚‰æ³¥ã€‚");
                    }},
                    { t:"æ‚„æ‚„ç¦»å¼€", f:()=>{ res("ç¨³å¥æ‰æ˜¯ä¿®ä»™å¤§è®¡ï¼Œä½ è‹Ÿä½äº†æ€§å‘½ã€‚", {luck:1}); }}
                ]
            };
        }
        const lvls = ['ç‚¼æ°”', 'ç­‘åŸº', 'é‡‘ä¸¹', 'å…ƒå©´', 'åŒ–ç¥', 'æ¸¡åŠ«'];
        const lvl = lvls[Math.min(5, Math.floor(age/150))];
        const plots = [`é—­å…³ä¿®ç‚¼ä¸­ï¼Œå¢ƒç•Œç¨³å›ºåœ¨${lvl}æœŸã€‚`, "å‚åŠ å®—é—¨å¤§æ¯”ï¼Œè™½ç„¶ç¬¬ä¸€è½®å°±è¢«æ·˜æ±°ï¼Œä½†ä½ å§¿åŠ¿å¾ˆå¸…ã€‚", "è·¯è¿‡å‡¡é—´ï¼Œå‘ç°å½“å¹´çš„ç‹æœå·²ç»è¦†ç­äº†ä¸‰æ¬¡ã€‚", "å°è¯•ç‚¼ä¸¹ï¼Œç‚¸æ¯äº†ä¸‰åº§å±±å¤´ã€‚"];
        return { text: `[${lvl}] ${plots[Math.floor(Math.random()*plots.length)]}` };
    }

    function getDatingEvt() {
        if (Math.random() < 0.2) {
            return {
                text: "æ ¡èŠ±/æ ¡è‰æŠŠä½ å µåœ¨å¢™è§’ï¼š'æˆ‘æƒ³ï¼Œæˆ‘ä»¬ä¹‹é—´æ˜¯ä¸æ˜¯æœ‰ä»€ä¹ˆè¯¯ä¼šï¼Ÿ'",
                highlight: true,
                choices: [
                    { t:"å£å’šå›å»", f:()=>{
                        if(stats.face>8) res("å¯¹æ–¹è„¸çº¢äº†ï¼Œå¥½æ„Ÿåº¦+100ã€‚", {luck:2});
                        else res("å¯¹æ–¹æŠ¥äº†è­¦ï¼Œè¯´ä½ éªšæ‰°ã€‚", {money:-2});
                    }},
                    { t:"å†·æ¼ èµ°å¼€", f:()=>{ res("å¯¹æ–¹è§‰å¾—ä½ çœŸæ˜¯ä¸ªæœ‰è¶£çš„ç”·äºº/å¥³äººï¼Œå¼•èµ·äº†æ³¨æ„ã€‚"); }},
                    { t:"å¤§å–Šæ•‘å‘½", f:()=>{ res("å…¨æ ¡éƒ½çŸ¥é“ä½ æ˜¯ä¸ªæ€‚åŒ…ï¼Œæ³¨å­¤ç”Ÿã€‚", {face:-2}); }}
                ]
            };
        }
        const plots = ["æ”¶åˆ°äº†åŒ¿åçš„æƒ…ä¹¦ï¼Œå­—è¿¹å¾ˆä¸‘ã€‚", "åœ¨å¤©å°ä¸€èµ·åƒä¾¿å½“ï¼Œé£å¾ˆå¤§ï¼Œå‘å‹ä¹±äº†ã€‚", "è¯¯å…¥æ›´è¡£å®¤ï¼Œå‘ç”Ÿäº†ä¸€äº›ä¸å¯æè¿°çš„å°´å°¬ã€‚", "é›¨å¤©æ²¡å¸¦ä¼ï¼ŒæœŸå¾…çš„å…±ä¼æƒ…èŠ‚æ²¡æœ‰å‘ç”Ÿã€‚"];
        return { text: plots[Math.floor(Math.random()*plots.length)] };
    }

    function getHorrorEvt() {
        if (Math.random() < 0.2) {
            return {
                text: "ä½ åœ¨æ¡Œä¸Šå‘ç°ä¸€å¼ çº¸æ¡ï¼šã€ä¸è¦ç»™æ•²é—¨çš„äººå¼€é—¨ã€‘ã€‚æ­¤æ—¶æ•²é—¨å£°å“èµ·ã€‚",
                highlight: true,
                choices: [
                    { t:"çœ‹çŒ«çœ¼", f:()=>{ die("çŒ«çœ¼å¤–æ˜¯ä¸€åªè¡€çº¢çš„çœ¼ç›ï¼Œå®ƒä¹Ÿåœ¨çœ‹ä½ ã€‚"); }},
                    { t:"ç›´æ¥å¼€é—¨", f:()=>{ die("é—¨å¤–ä¹Ÿæ˜¯ä½ è‡ªå·±ã€‚ä½ è¢«æ›¿ä»£äº†ã€‚"); }},
                    { t:"è£…ä¸åœ¨å®¶", f:()=>{ res("æ•²é—¨å£°æŒç»­äº†ä¸€æ•´å¤œï¼Œä½ ç²¾ç¥è¡°å¼±ï¼Œä½†æ´»ä¸‹æ¥äº†ã€‚", {body:-2}); }}
                ]
            };
        }
        const plots = ["å®¶é‡Œçš„é•œå­å¤šäº†ä¸€é¢ï¼Œä½ è®°å¾—ä½ æ²¡ä¹°è¿‡ã€‚", "åŠå¤œå¬åˆ°å¨æˆ¿æœ‰å’€åš¼å£°ã€‚", "æ‰‹æœºæ”¶åˆ°æœªæ¥çš„çŸ­ä¿¡ï¼š'åˆ«å›å¤´'ã€‚", "èµ°æ¥¼æ¢¯æ—¶ï¼Œå‘ç°å¤šäº†ä¸€çº§å°é˜¶ã€‚"];
        return { text: plots[Math.floor(Math.random()*plots.length)] };
    }

    function getCthulhuEvt() {
        if (Math.random() < 0.2) {
            return {
                text: "ä½ æ¡åˆ°ä¸€æœ¬ç”¨äººçš®è£…è®¢çš„ä¹¦ï¼Œæ–‡å­—åœ¨è •åŠ¨ã€‚",
                highlight: true,
                choices: [
                    { t:"é˜…è¯»", f:()=>{
                        if(stats.iq > 9) res("ä½ ç†è§£äº†å®‡å®™çš„çœŸç†ï¼Œå¹¶ç–¯äº†ã€‚", {iq:10}); 
                        else die("ä½ çš„è„‘æµ†æ²¸è…¾äº†ã€‚");
                    }},
                    { t:"çƒ§æ‰", f:()=>{ res("ä¹¦å‘å‡ºå°–å«å£°åŒ–ä¸ºç°çƒ¬ï¼Œä½ é—»åˆ°äº†æµ·è…¥å‘³ã€‚"); }}
                ]
            };
        }
        return { text: "é‚»å±…çš„è„¸å¶å°”ä¼šå˜æˆç« é±¼ã€‚" };
    }

    function getFantasyEvt() {
        return { text: "ä½ å­¦ä¹ äº†ä¸€ä¸ªç«çƒæœ¯ï¼Œç”¨æ¥ç‚¹çƒŸå¾ˆæ–¹ä¾¿ã€‚" };
    }

    function getSpeciesText() {
        const t = {
            'é«˜é›…ä¼é¹…': ["ä¼˜é›…åœ°åƒäº†ä¸€åªç£·è™¾ã€‚", "åœ¨å—æä¸¾åŠäº†çº¢é…’å“é‰´ä¼šã€‚", "è¢«åšæˆäº†è¡¨æƒ…åŒ…ã€‚", "å› ä¸ºå…¨çƒå˜æš–æ¬å®¶äº†ã€‚"],
            'èµ›åšèŸ‘è‚': ["åå™¬äº†ä¸€å—èŠ¯ç‰‡ï¼Œæ™ºåŠ›+1ã€‚", "èº²è¿‡äº†æ€è™«å‰‚çš„æ¯’é›¾ã€‚", "è¿æ¥ä¸Šäº†äººç±»çš„ç½‘ç»œã€‚", "åœ¨æ ¸åºŸå¢Ÿçœ‹å¤•é˜³ã€‚"],
            'ä¸€æ£µæ ‘': ["å…‰åˆä½œç”¨ä¸­...", "ä¸€åªç‹—åœ¨ä½ è„šä¸‹æ’’å°¿ã€‚", "è¢«åˆ»äº†'åˆ°æ­¤ä¸€æ¸¸'ã€‚", "é¸Ÿåœ¨ä½ å¤´ä¸Šç­‘å·¢ã€‚"],
            'å²è±å§†': ["åˆ†è£‚å‡ºäº†ä¸€ä¸ªæ–°çš„è‡ªå·±ã€‚", "è¢«å‹‡è€…è¿½æ€ï¼Œèº²è¿›äº†ç½å­é‡Œã€‚", "æº¶è§£äº†ä¸€æŠŠé“å‰‘ã€‚"]
        };
        const list = t[species] || ["æ­£åœ¨åŠªåŠ›ç”Ÿå­˜..."];
        return list[Math.floor(Math.random()*list.length)];
    }

    // --- è¾…åŠ©åŠŸèƒ½ ---
    function showInteraction(opts) {
        dom.interaction.innerHTML = '';
        dom.interaction.style.display = 'flex';
        opts.forEach(o => {
            const btn = document.createElement('button');
            btn.className = 'action-btn';
            btn.innerText = "â¤ " + o.t;
            btn.onclick = () => {
                dom.interaction.style.display = 'none';
                o.f();
            };
            dom.interaction.appendChild(btn);
        });
    }

    function res(msg, chg) {
        addLog(`ã€ç»“æœã€‘${msg}`, currentMode, true);
        if (chg) for(let k in chg) stats[k] += chg[k];
        gameLoop();
    }

    function checkDeath() {
        let rate = 0.002;
        if (currentMode==='horror'||currentMode==='cthulhu') rate=0.05;
        if (currentMode==='xiuxian' && age%100===0) rate=0.1; // æ¸¡åŠ«éš¾å…³

        if (Math.random() < rate) {
            die("é­é‡ä¸å¯æŠ—åŠ›ï¼Œä½ çš„ç”Ÿå‘½æˆ›ç„¶è€Œæ­¢ã€‚");
            return true;
        }
        if (age > 1000) { die("å¯¿å…ƒè€—å°½ï¼Œé‡å…¥è½®å›ã€‚"); return true; }
        return false;
    }

    function die(reason) {
        isDead = true;
        clearTimeout(gameTimer);
        const div = document.createElement('div');
        div.className = 'log-item';
        div.innerHTML = `<span class="die-msg">ğŸ’€ æ­»äº¡ï¼š${reason}</span>`;
        dom.log.appendChild(div);
        dom.log.scrollTop = dom.log.scrollHeight;
        dom.restart.style.display = 'block';
    }

    function addLog(text, mode, hl) {
        const div = document.createElement('div');
        div.className = `log-item txt-${mode} ${hl?'highlight':''}`;
        div.innerHTML = `<span class="age-tag">${age>=0?age+'å²':'ç³»ç»Ÿ'}</span> ${text}`;
        dom.log.appendChild(div);
        dom.log.scrollTop = dom.log.scrollHeight;
    }

    function resetGame() {
        switchScreen('screen-start');
        init();
    }

    // å¯åŠ¨
    init();

</script>
</body>
</html>