<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é«˜é›…äººç”Ÿé‡å¼€æ¨¡æ‹Ÿå™¨ v3.5 ğŸ§</title>
    <style>
        :root {
            --bg-color: #f0f2f5;
            --card-bg: #ffffff;
            --primary: #2c3e50;
            --text-main: #333;
            --accent: #d35400;
            --highlight-bg: rgba(231, 76, 60, 0.08);
        }

        * { box-sizing: border-box; }

        body {
            font-family: 'Helvetica Neue', Helvetica, 'PingFang SC', 'Microsoft YaHei', Arial, sans-serif;
            background-color: var(--bg-color);
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            color: var(--text-main);
            transition: background-color 0.8s ease, color 0.8s ease;
            background-image: radial-gradient(#dce4ec 1px, transparent 1px);
            background-size: 20px 20px;
        }

        body.mode-xiuxian { --bg-color: #e8f5e9; --primary: #2e7d32; --card-bg: #f1f8e9; background-image: none; }
        body.mode-2d { --bg-color: #fce4ec; --primary: #c2185b; --card-bg: #fff0f5; background-image: none; }
        body.mode-horror { --bg-color: #1a1a1a; --primary: #000; --card-bg: #2a2a2a; --text-main: #b0bec5; background-image: none; }
        body.mode-cthulhu { --bg-color: #1b2838; --primary: #0a3d2e; --card-bg: #253447; --text-main: #8fa3b0; background-image: none; }
        body.mode-xuanhuan { --bg-color: #fff3e0; --primary: #e65100; --card-bg: #ffe0b2; background-image: none; }

        .container {
            width: 100%;
            max-width: 500px;
            background: var(--card-bg);
            border-radius: 24px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.1);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            height: 90vh;
            position: relative;
            transition: all 0.8s ease;
        }

        @keyframes heartbeat {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.01); }
        }
        body.mode-2d .container { animation: heartbeat 1.5s infinite; }

        .header {
            background: var(--primary);
            color: white;
            padding: 15px;
            text-align: center;
            font-size: 1.2rem;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            transition: background 0.8s ease;
            z-index: 10;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .penguin-icon { font-size: 1.5rem; animation: waddle 1s infinite alternate; }
        @keyframes waddle { from { transform: rotate(-10deg); } to { transform: rotate(10deg); } }

        .screen { padding: 25px; flex: 1; display: none; flex-direction: column; overflow-y: auto; }
        .screen.active { display: flex; }

        .start-screen { text-align: center; justify-content: center; }
        .meme-banner { font-size: 70px; margin: 20px 0; animation: float 3s ease-in-out infinite; }
        @keyframes float { 0%, 100% { transform: translateY(0px); } 50% { transform: translateY(-15px); } }
        .subtitle { font-size: 0.9rem; color: #666; margin-top: 10px; font-style: italic; }
        .version-info { margin-top: 30px; font-size: 0.8rem; color: #999; text-align: left; background: #f8f9fa; padding: 15px; border-radius: 10px; }
        .special-hint { color: var(--accent); font-weight: bold; }
        .warning-box { background: #fff3cd; border-left: 4px solid #ff6b6b; padding: 12px; margin-top: 15px; border-radius: 8px; color: #856404; font-size: 0.85rem; }

        .btn {
            background: var(--primary); color: white; border: none; padding: 16px 32px; font-size: 1.05rem;
            border-radius: 50px; cursor: pointer; margin-top: 25px; box-shadow: 0 6px 15px rgba(0,0,0,0.1);
            transition: all 0.2s; font-weight: bold; letter-spacing: 1px;
        }
        .btn:active { transform: scale(0.95); }
        #restart-btn { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); display: none; z-index: 100; width: 85%; max-width: 460px; }

        .setup-screen h2 { text-align: center; margin-bottom: 25px; color: var(--primary); }
        .gender-select { display: flex; justify-content: center; gap: 10px; margin-bottom: 25px; flex-wrap: wrap; }
        .gender-btn { padding: 10px 20px; border: 2px solid #ddd; background: transparent; border-radius: 12px; cursor: pointer; color: var(--text-main); font-weight: bold; transition: all 0.2s; font-size: 0.9rem; }
        .gender-btn.selected { background: var(--primary); color: white; border-color: var(--primary); }
        .points-counter { text-align: center; font-weight: bold; margin-bottom: 20px; font-size: 1.1rem; }

        .stat-row { margin-bottom: 18px; display: flex; align-items: center; gap: 12px; background: #f8f9fa; padding: 10px; border-radius: 12px; }
        .stat-label { width: 60px; font-weight: bold; display: flex; align-items: center; gap: 5px; font-size: 0.9rem; }
        input[type="range"] { flex: 1; accent-color: var(--primary); cursor: pointer; height: 6px; }
        .stat-val { font-weight: bold; color: var(--primary); width: 30px; text-align: right; }

        #log-container { flex: 1; overflow-y: auto; padding-bottom: 120px; scroll-behavior: smooth; -webkit-overflow-scrolling: touch; }
        .log-item {
            padding: 12px 5px;
            border-bottom: 1px solid rgba(0,0,0,0.05);
            font-size: 0.95rem;
            line-height: 1.6;
            opacity: 0;
            animation: slideUp 0.4s ease-out forwards;
        }
        @keyframes slideUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .age-tag {
            display: inline-block; background: var(--primary); color: white; padding: 3px 8px; border-radius: 6px;
            font-size: 0.75rem; margin-right: 10px; min-width: 32px; text-align: center; font-weight: bold;
        }

        .highlight { color: #c0392b; font-weight: bold; background: var(--highlight-bg); padding: 2px 6px; border-radius: 4px; }
        .golden { color: #f39c12; font-weight: 900; text-shadow: 1px 1px 0 rgba(0,0,0,0.1); }
        
        .xiuxian-text { color: #2e7d32; font-weight: bold; }
        .anime-text { color: #d81b60; }
        .horror-text { color: #ff5252; font-weight: bold; }
        .cthulhu-text { color: #4db6ac; font-style: italic; }
        .xuanhuan-text { color: #ff6f00; font-weight: bold; }

        .choice-box {
            background: rgba(255,255,255,0.95);
            border: 2px solid var(--primary);
            border-radius: 12px;
            padding: 15px;
            margin: 15px 0;
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
        }
        .choice-title { font-weight: bold; margin-bottom: 12px; color: var(--primary); font-size: 1rem; }
        .choice-btn {
            display: block;
            width: 100%;
            padding: 12px;
            margin: 8px 0;
            background: #eceff1;
            border: 2px solid #b0bec5;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.9rem;
            color: #333;
            text-align: left;
        }
        .choice-btn:active { transform: scale(0.98); background: var(--primary); color: white; border-color: var(--primary); }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.6);
            justify-content: center;
            align-items: center;
        }
        .modal.active { display: flex; }
        .modal-content {
            background: white;
            padding: 25px;
            border-radius: 16px;
            max-width: 350px;
            width: 85%;
            text-align: center;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }
        .modal-content h3 { margin-top: 0; color: #c0392b; }
        .modal-btn {
            padding: 12px 24px;
            margin: 8px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.2s;
        }
        .modal-btn.confirm { background: #e74c3c; color: white; }
        .modal-btn.cancel { background: #95a5a6; color: white; }
        .modal-btn:active { transform: scale(0.95); }

    </style>
</head>
<body>

<div class="container">
    <div class="header" id="header-bar">
        <span class="penguin-icon">ğŸ§</span>
        <span id="title-text">é«˜é›…äººç”Ÿæ¨¡æ‹Ÿå™¨</span>
        <span class="penguin-icon">ğŸ·</span>
    </div>

    <div id="screen-start" class="screen active start-screen">
        <div class="meme-banner">ğŸ•´ï¸ğŸ²ğŸ¦‘</div>
        <h1>äººç”Ÿé‡å¼€ v3.5</h1>
        <p class="subtitle">"åšäººå¤ªç´¯äº†ï¼Œä¸å¦‚åšä¸ªé«˜é›…çš„ä¼é¹…ã€‚"</p>
        
        <div class="version-info">
            <strong>æœ¬å‘¨ç›®ç‰¹è‰²ï¼š</strong><br>
            â€¢ å¯è½¬ç”Ÿä¸ºéäººç±»ç‰©ç§<br>
            â€¢ éšæœºæš´æ¯™ç³»ç»Ÿ<br>
            â€¢ <span class="special-hint">å¤šæ¡ä¸–ç•Œçº¿ä¸äº’åŠ¨é€‰æ‹©</span>
        </div>

        <div class="warning-box">
            âš ï¸ <strong>å†…å®¹è­¦å‘Šï¼š</strong>æœ¬æ¸¸æˆå«å¾®ææ€–å‘å†…å®¹ï¼Œå¿ƒç†æ‰¿å—èƒ½åŠ›è¾ƒå¼±è€…è¯·è°¨æ…æ¸¸ç©
        </div>
        
        <button class="btn" onclick="goToSetup()">å¼€å§‹æŠ½å¡</button>
    </div>

    <div id="screen-setup" class="screen setup-screen">
        <h2>å®šåˆ¶ä½ çš„å¤©èµ‹ (20ç‚¹)</h2>
        <div class="gender-select">
            <button class="gender-btn selected" onclick="selectGender('male', this)">ç”·</button>
            <button class="gender-btn" onclick="selectGender('female', this)">å¥³</button>
            <button class="gender-btn" onclick="selectGender('other', this)">???</button>
        </div>
        
        <div class="points-counter" style="color:var(--accent)">
            å‰©ä½™ç‚¹æ•°: <span id="points-display">20</span>
        </div>

        <div id="sliders-container"></div>

        <button class="btn" onclick="startGame()">å¼€å¯éšæœºäººç”Ÿ</button>
    </div>

    <div id="screen-game" class="screen game-screen">
        <div id="log-container"></div>
        <button id="restart-btn" class="btn" onclick="resetGame()">å†æ¬¡é‡å¼€</button>
    </div>
</div>

<div id="horror-modal" class="modal">
    <div class="modal-content">
        <h3>âš ï¸ æ³¨æ„</h3>
        <p>å³å°†è¿›å…¥<strong id="modal-mode-name">ææ€–</strong>æ¨¡æ‹Ÿå™¨çº¿è·¯</p>
        <p style="font-size: 0.9rem; color: #666;">è¯¥çº¿è·¯åŒ…å«å¾®ææ€–å†…å®¹ï¼Œæ˜¯å¦ç»§ç»­ï¼Ÿ</p>
        <button class="modal-btn confirm" onclick="confirmHorrorMode()">ç»§ç»­æ¸¸ç©</button>
        <button class="modal-btn cancel" onclick="cancelHorrorMode()">å–æ¶ˆ</button>
    </div>
</div>

<script>
const TOTAL_POINTS = 20;
const statConfig = [
    { key: 'face', name: 'é¢œå€¼', icon: 'ğŸ’…' },
    { key: 'iq', name: 'æ™ºå•†', icon: 'ğŸ§ ' },
    { key: 'body', name: 'ä½“è´¨', icon: 'ğŸ’ª' },
    { key: 'money', name: 'å®¶å¢ƒ', icon: 'ğŸ’°' },
    { key: 'luck', name: 'æ°”è¿', icon: 'ğŸ€' }
];

const speciesList = ['é«˜é›…ä¼é¹…', 'æ°´è±š', 'èµ›åšèŸ‘è‚', 'ä¸€æ£µæ ‘', 'å²è±å§†'];

let remainingPoints = TOTAL_POINTS;
let stats = { face:0, iq:0, body:0, money:0, luck:0 };
let selectedGenderTag = 'male';
let finalGenderOrSpecies = 'äººç±»ç”·æ€§';
let age = 0;
let isDead = false;
let gameInterval = null;
let currentMode = 'normal';
let lastEventText = "";
let repeatCount = 0;
let pendingHorrorMode = null;
let choiceMade = false;
let modeStage = 0;

const humanEvents = [
    "ä½ æ²‰è¿·äºç½‘ç»œä¸Šçš„é«˜é›…è‰ºæœ¯é‰´èµè§†é¢‘ã€‚",
    "èµ°è·¯æ—¶ä¸ºäº†èº²é¿èš‚èšï¼Œä½ æ‘”äº†ä¸ªç‹—åƒå±ã€‚",
    "ä½ è¯•å›¾å­¦åšé¥­ï¼Œç»“æœç‚¸äº†å¨æˆ¿ã€‚",
    "ä½ åœ¨ç½‘ä¸Šå‘å¸–è·å¾—äº†10ä¸‡+ç‚¹èµã€‚",
    "å¹³æ·¡çš„ä¸€å¹´ã€‚"
];

const speciesEvents = {
    'é«˜é›…ä¼é¹…': ["ä½ æ··å…¥äº†äººç±»çš„é«˜çº§æ™šå®´ã€‚", "ä½ åœ¨è…¾è®¯æ€»éƒ¨å‰å¾˜å¾Šã€‚"],
    'èµ›åšèŸ‘è‚': ["ä½ åœ¨æ ¸åºŸå¢Ÿä¸­é†’æ¥ã€‚", "ä½ è¯•å›¾å•ƒé£Ÿç”µçº¿ã€‚"],
    'ä¸€æ£µæ ‘': ["å…‰åˆä½œç”¨ä¸­...", "ä¸€åªç‹—åœ¨ä½ è„šä¸‹æ’’å°¿ã€‚"]
};

const xiuxianEvents = [
    "ä½ æ„Ÿè§‰åˆ°ç©ºæ°”ä¸­æœ‰å¥‡å¦™çš„æ³¢åŠ¨ï¼Œå¼•æ°”å…¥ä½“ï¼",
    "ä½ åœ¨åœ°æ‘Šä¸Šä¹°åˆ°äº†ä¸€æœ¬å‘å…‰çš„å¤ç±ã€‚",
    "é—­å…³ä¿®ç‚¼ä¸­ï¼Œå¢ƒç•Œæ¾åŠ¨ã€‚",
    "ä½ å¾¡å‰‘é£è¡Œé€å¤–å–ï¼Œä»æœªè¶…æ—¶ã€‚",
    "å°è¯•çªç ´ï¼Œå¤©é™é›·åŠ«ï¼"
];

const loveEvents = [
    "ç”»é£çªå˜ï¼Œå‘¨å›´çš„äººçœ¼ç›éƒ½å˜å¤§äº†ï¼",
    "å­¦æ ¡è½¬æ¥ç¥ç§˜è½¬æ ¡ç”Ÿï¼Œååœ¨åæ’é çª—ã€‚",
    "ä½ åœ¨å›¾ä¹¦é¦†ä¸TAå››ç›®ç›¸å¯¹ã€‚",
    "æ”¶åˆ°äº†ä¸€å°åŒ¿åæƒ…ä¹¦ã€‚",
    "æ–‡åŒ–ç¥­å½“å¤©ï¼Œæœ‰äººå‘ä½ å‘Šç™½ã€‚"
];

const horrorEvents = [
    "ä»Šæ™šçš„æœˆäº®æ˜¯çº¢è‰²çš„ã€‚",
    "é•œå­é‡Œçš„ä½ æ²¡æœ‰çœ¨çœ¼ã€‚",
    "æ€»æ„Ÿè§‰èº«åæœ‰è„šæ­¥å£°ã€‚",
    "æ”¶åˆ°äº†è‡ªå·±å·ç å‘æ¥çš„çŸ­ä¿¡ï¼š'ä¸è¦å›å¤´'ã€‚",
    "åŠå¤œé†’æ¥ï¼Œæˆ¿é—´é‡Œå¤šäº†ä¸€ä¸ªå½±å­ã€‚"
];

const cthulhuEvents = [
    "ä½ åœ¨æµ·è¾¹æ¡åˆ°åˆ»ç€è¯¡å¼‚ç¬¦å·çš„çŸ³å¤´ã€‚",
    "æ¢¦è§æ·±æµ·ä¸­æœ‰ä»€ä¹ˆåœ¨å‘¼å”¤ä½ ã€‚",
    "ä½ å¼€å§‹å¯¹å¤è€çš„æ–‡æ˜äº§ç”Ÿå…´è¶£ã€‚",
    "é˜…è¯»ç¦å¿Œä¹¦ç±ï¼Œç†æ™ºå€¼ä¸‹é™ã€‚",
    "ä½ çœ‹åˆ°äº†ä¸è¯¥çœ‹çš„ä¸œè¥¿ã€‚"
];

const xuanhuanEvents = [
    "ä½ ä½“å†…è§‰é†’äº†è¿œå¤è¡€è„‰ï¼",
    "å¤©é™å¼‚è±¡ï¼Œç´«æ°”ä¸œæ¥ä¸‰ä¸‡é‡Œï¼",
    "è·å¾—äº†ä¸€æšç¥ç§˜æˆ’æŒ‡ã€‚",
    "é‡åˆ°äº†ç»ä¸–é«˜äººæŒ‡ç‚¹ã€‚",
    "ä½ çš„å¤©èµ‹éœ‡æƒŠäº†æ‰€æœ‰äººã€‚"
];

function initSetup() {
    const container = document.getElementById('sliders-container');
    container.innerHTML = '';
    statConfig.forEach(stat => {
        container.innerHTML += `
            <div class="stat-row">
                <label class="stat-label">${stat.icon} ${stat.name}</label>
                <input type="range" min="0" max="10" value="0" data-key="${stat.key}" oninput="handleInput('${stat.key}', this.value)">
                <span class="stat-val" id="val-${stat.key}">0</span>
            </div>`;
    });
    resetStatsUI();
}

function resetStatsUI() {
    remainingPoints = TOTAL_POINTS;
    for(let k in stats) stats[k] = 0;
    document.querySelectorAll('input[type="range"]').forEach(el => el.value = 0);
    document.querySelectorAll('.stat-val').forEach(el => el.innerText = '0');
    updatePointDisplay();
}

function handleInput(key, val) {
    val = parseInt(val);
    let used = 0;
    document.querySelectorAll('input[type="range"]').forEach(input => {
        if(input.dataset.key !== key) used += parseInt(input.value);
    });
    
    if (used + val > TOTAL_POINTS) {
        val = TOTAL_POINTS - used;
        document.querySelector(`input[data-key="${key}"]`).value = val;
    }
    
    stats[key] = val;
    document.getElementById(`val-${key}`).innerText = val;
    remainingPoints = TOTAL_POINTS - (used + val);
    updatePointDisplay();
}

function updatePointDisplay() {
    const pDisplay = document.getElementById('points-display');
    pDisplay.innerText = remainingPoints;
    pDisplay.style.color = remainingPoints === 0 ? '#27ae60' : '#d35400';
}

function selectGender(tag, btn) {
    selectedGenderTag = tag;
    document.querySelectorAll('.gender-btn').forEach(b => b.classList.remove('selected'));
    btn.classList.add('selected');
}

function switchScreen(screenId) {
    document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
    document.getElementById(screenId).classList.add('active');
}

function goToSetup() { switchScreen('screen-setup'); }

function startGame() {
    if (remainingPoints > 0) { alert("å±æ€§ç‚¹æ²¡åˆ†å®Œï¼"); return; }
    
    switchScreen('screen-game');
    
    age = -1; isDead = false; currentMode = 'normal'; modeStage = 0;
    document.body.className = '';
    document.getElementById('log-container').innerHTML = '';
    document.getElementById('restart-btn').style.display = 'none';
    document.getElementById('title-text').innerText = "é«˜é›…äººç”Ÿæ¨¡æ‹Ÿå™¨";

    if (selectedGenderTag === 'other') {
        finalGenderOrSpecies = speciesList[Math.floor(Math.random() * speciesList.length)];
    } else {
        finalGenderOrSpecies = selectedGenderTag === 'male' ? 'äººç±»ç”·æ€§' : 'äººç±»å¥³æ€§';
    }

    addLog(`è½¬ç”Ÿèº«ä»½:ã€${finalGenderOrSpecies}ã€‘`, false, false);
    
    gameInterval = setInterval(gameLoop, 800);
}

function gameLoop() {
    age++;
    
    if (checkSuddenDeath()) return;

    let maxAge = finalGenderOrSpecies.includes('äººç±»') ? 100 : 30;
    if (currentMode === 'xiuxian') maxAge = 1000;
    
    if (age > maxAge && Math.random() < 0.3) {
        die(`å¯¿ç»ˆæ­£å¯ï¼Œäº«å¹´${age}å²ã€‚`);
        return;
    }

    generateEvent();
    
    const logBox = document.getElementById('log-container');
    logBox.scrollTop = logBox.scrollHeight;
}

function checkSuddenDeath() {
    if (age <= 0) return false;
    let deathChance = 0.002;
    
    if (stats.body < 4) deathChance += 0.005;
    if (stats.luck < 3) deathChance += 0.008;
    if (currentMode === 'horror') deathChance += 0.05;

    if (Math.random() < deathChance) {
        let reason = "å–æ°´å‘›æ­»äº†ã€‚";
        if (currentMode === 'horror') reason = "ä½ çªç„¶æ¶ˆå¤±äº†ï¼Œåœ°ä¸Šåªå‰©ä¸€æ»©æ°´ã€‚";
        die(`ã€çªå‘æ¶è®¯ã€‘${reason}`);
        return true;
    }
    return false;
}

function die(msg) {
    clearInterval(gameInterval);
    isDead = true;
    addLog(msg, true);
    document.getElementById('restart-btn').style.display = 'block';
}

function generateEvent() {
    let text = "";
    let styleClass = "";
    let isHighlight = false;
    let isGolden = false;

    if (currentMode === 'normal' && finalGenderOrSpecies.includes('äººç±»') && age > 5 && Math.random() < 0.1) {
        const roll = Math.random();
        if (roll < 0.2 && stats.iq > 6) {
            pendingHorrorMode = 'xiuxian';
            showHorrorModal('ä¿®ä»™');
            return;
        } else if (roll < 0.4 && stats.face > 7) {
            pendingHorrorMode = '2d';
            showHorrorModal('æ‹çˆ±å…»æˆ');
            return;
        } else if (roll < 0.6) {
            pendingHorrorMode = 'horror';
            showHorrorModal('è§„åˆ™æ€ªè°ˆ');
            return;
        } else if (roll < 0.8) {
            pendingHorrorMode = 'cthulhu';
            showHorrorModal('å…‹è‹é²');
            return;
        } else {
            pendingHorrorMode = 'xuanhuan';
            showHorrorModal('ç„å¹»');
            return;
        }
    }

    if (currentMode === 'xiuxian') {
        text = getRandom(xiuxianEvents);
        styleClass = "xiuxian-text";
        if (age === 50 && !choiceMade) {
            showChoice("ä½ é‡åˆ°äº†ä¸€ä½ä»™äºº", [
                {text: "æ‹œå¸ˆå­¦è‰º", effect: () => { addLog("ä½ æˆåŠŸæ‹œå¸ˆï¼", false, true); choiceMade = true; }},
                {text: "å©‰æ‹’ç¦»å¼€", effect: () => { addLog("ä½ é”™å¤±æœºç¼˜ã€‚", true); choiceMade = true; }}
            ]);
            return;
        }
    } else if (currentMode === '2d') {
        text = getRandom(loveEvents);
        styleClass = "anime-text";
        if (age === 18 && !choiceMade) {
            showChoice("æ–‡åŒ–ç¥­æœ‰äººå‘ä½ å‘Šç™½", [
                {text: "æ¥å—å‘Šç™½", effect: () => { addLog("ä½ ä»¬åœ¨ä¸€èµ·äº†ï¼", false, true); choiceMade = true; }},
                {text: "å©‰æ‹’å¯¹æ–¹", effect: () => { addLog("ä½ é€‰æ‹©äº†å­¤ç‹¬ã€‚", true); choiceMade = true; }}
            ]);
            return;
        }
    } else if (currentMode === 'horror') {
        text = getRandom(horrorEvents);
        styleClass = "horror-text";
        isHighlight = true;
    } else if (currentMode === 'cthulhu') {
        text = getRandom(cthulhuEvents);
        styleClass = "cthulhu-text";
    } else if (currentMode === 'xuanhuan') {
        text = getRandom(xuanhuanEvents);
        styleClass = "xuanhuan-text";
        isGolden = true;
    } else {
        if (age === 0) {
            text = "ä½ å‡ºç”Ÿäº†ã€‚";
        } else if (!finalGenderOrSpecies.includes('äººç±»')) {
            let pool = speciesEvents[finalGenderOrSpecies] || humanEvents;
            text = getRandom(pool);
        } else {
            text = getRandom(humanEvents);
        }
    }

    if (text === lastEventText) {
        repeatCount++;
        if (repeatCount < 3) return;
        text = "æ•°å¹´å¹³æ·¡åº¦è¿‡...";
        repeatCount = 0;
    } else {
        repeatCount = 0;
    }
    lastEventText = text;

    addLog(text, isHighlight, isGolden, styleClass);
}

function switchMode(mode) {
    currentMode = mode;
    document.body.className = `mode-${mode}`;
    const titles = {
        'xiuxian': 'ä¿®ä»™æ¨¡æ‹Ÿå™¨',
        '2d': 'æ‹çˆ±å…»æˆæ¨¡æ‹Ÿå™¨',
        'horror': 'è§„åˆ™æ€ªè°ˆæ¨¡æ‹Ÿå™¨',
        'cthulhu': 'å…‹è‹é²æ¨¡æ‹Ÿå™¨',
        'xuanhuan': 'ç„å¹»æ¨¡æ‹Ÿå™¨'
    };
    document.getElementById('title-text').innerText = titles[mode] || 'é«˜é›…äººç”Ÿæ¨¡æ‹Ÿå™¨';
}

function showHorrorModal(modeName) {
    clearInterval(gameInterval);
    document.getElementById('modal-mode-name').innerText = modeName;
    document.getElementById('horror-modal').classList.add('active');
}

function confirmHorrorMode() {
    document.getElementById('horror-modal').classList.remove('active');
    if (pendingHorrorMode) {
        switchMode(pendingHorrorMode);
        addLog(`ã€ä¸–ç•Œçº¿å˜åŠ¨ã€‘è¿›å…¥${pendingHorrorMode}çº¿ï¼`, true, true);
        pendingHorrorMode = null;
    }
    gameInterval = setInterval(gameLoop, 800);
}

function cancelHorrorMode() {
    document.getElementById('horror-modal').classList.remove('active');
    pendingHorrorMode = null;
    addLog("ä½ æ„Ÿè§‰åˆ°ä¸€é˜µçœ©æ™•ï¼Œä½†å¾ˆå¿«æ¢å¤æ­£å¸¸ã€‚", false);
    gameInterval = setInterval(gameLoop, 800);
}

function showChoice(title, options) {
    clearInterval(gameInterval);
    const logBox = document.getElementById('log-container');
    
    const choiceDiv = document.createElement('div');
    choiceDiv.className = 'choice-box';
    choiceDiv.innerHTML = `<div class="choice-title">${title}</div>`;
    
    options.forEach(opt => {
        const btn = document.createElement('button');
        btn.className = 'choice-btn';
        btn.innerText = opt.text;
        btn.onclick = () => {
            opt.effect();
            choiceDiv.remove();
            gameInterval = setInterval(gameLoop, 800);
        };
        choiceDiv.appendChild(btn);
    });
    
    logBox.appendChild(choiceDiv);
    logBox.scrollTop = logBox.scrollHeight;
}

function getRandom(arr) {
    return arr[Math.floor(Math.random() * arr.length)];
}

function addLog(text, isHighlight, isGolden, customClass) {
    const div = document.createElement('div');
    div.className = 'log-item';
    let content = `<span class="age-tag">${age}å²</span> ${text}`;
    if (age === -1) content = `<span class="age-tag" style="background:#95a5a6">ç³»ç»Ÿ</span> ${text}`;
    div.innerHTML = content;
    if (isHighlight) div.classList.add('highlight');
    if (isGolden) div.classList.add('golden');
    if (customClass) div.classList.add(customClass);
    document.getElementById('log-container').appendChild(div);
}

function resetGame() {
    switchScreen('screen-start');
    document.body.className = '';
    choiceMade = false;
    initSetup();
}

initSetup();
</script>

</body>
</html>