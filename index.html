<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>é«˜é›…äººç”Ÿæ¨¡æ‹Ÿå™¨ v4.0 ç»ˆæç‰ˆ</title>
    <style>
        :root {
            --bg-color: #f0f2f5;
            --card-bg: #ffffff;
            --primary: #2c3e50;
            --text-main: #333;
            --accent: #d35400;
        }

        body {
            font-family: 'Helvetica Neue', Helvetica, 'PingFang SC', 'Microsoft YaHei', Arial, sans-serif;
            background-color: var(--bg-color);
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            color: var(--text-main);
            transition: all 1s ease;
            overflow: hidden; /* é˜²æ­¢ç‰¹æ•ˆæº¢å‡º */
        }

        /* --- è§†è§‰ç‰¹æ•ˆå±‚ --- */
        #vfx-layer {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; z-index: 1; mix-blend-mode: overlay; opacity: 0;
            transition: opacity 1s;
        }

        /* æ¨¡å¼ç‰¹æ•ˆ */
        body.mode-xiuxian { --bg-color: #e0f7fa; --primary: #006064; font-family: "KaiTi", serif; }
        body.mode-xiuxian #vfx-layer { background: radial-gradient(circle, rgba(255,215,0,0.1) 0%, transparent 70%); opacity: 1; }
        
        body.mode-dating { --bg-color: #fff0f5; --primary: #e91e63; }
        body.mode-dating #vfx-layer { background-image: url("data:image/svg+xml,%3Csvg width='20' height='20' viewBox='0 0 20 20' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M10 15l-1-1C4 10 2 8 2 5c0-2 2-3 4-3 2 0 3 2 4 3 1-1 2-3 4-3 2 0 4 1 4 3 0 3-2 5-7 9l-1 1z' fill='%23ff69b4' fill-opacity='0.2'/%3E%3C/svg%3E"); opacity: 1; animation: slideBg 10s linear infinite; }

        body.mode-horror { --bg-color: #000; --primary: #fff; --card-bg: #1a1a1a; --text-main: #ccc; }
        body.mode-horror #vfx-layer { box-shadow: inset 0 0 100px #000; opacity: 1; animation: flicker 0.1s infinite; pointer-events: none;}
        
        body.mode-cthulhu { --bg-color: #1a0f1f; --primary: #4a148c; --card-bg: #221a25; --text-main: #9e9e9e; }
        body.mode-cthulhu .container { filter: blur(0.5px) contrast(1.2); animation: breathe 5s infinite; }
        
        body.mode-fantasy { --bg-color: #f9fbe7; --primary: #33691e; }
        
        @keyframes slideBg { from { background-position: 0 0; } to { background-position: 50px 50px; } }
        @keyframes flicker { 0% { opacity: 0.1; } 10% { opacity: 0.15; } 90% { opacity: 0.1; } 100% { opacity: 0.2; } }
        @keyframes breathe { 0% { transform: scale(1); } 50% { transform: scale(1.01); } 100% { transform: scale(1); } }
        @keyframes glitch { 0% { transform: translate(0); } 20% { transform: translate(-2px, 2px); } 40% { transform: translate(-2px, -2px); } 60% { transform: translate(2px, 2px); } 80% { transform: translate(2px, -2px); } 100% { transform: translate(0); } }

        .container {
            width: 95%; max-width: 500px;
            background: var(--card-bg);
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            display: flex; flex-direction: column;
            height: 90vh; position: relative; z-index: 2;
            transition: all 0.5s;
        }

        .header {
            background: var(--primary); color: white; padding: 15px;
            text-align: center; font-weight: bold; display: flex;
            justify-content: center; gap: 10px; z-index: 10;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            font-size: 1.1rem;
        }

        .screen { padding: 20px; flex: 1; display: none; flex-direction: column; overflow-y: auto; position: relative; }
        .screen.active { display: flex; }

        /* start screen */
        .warning-tag { background: #e74c3c; color: white; padding: 5px 10px; border-radius: 4px; font-size: 0.8rem; margin-top: 10px; display: inline-block; animation: pulse 2s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.7; } 100% { opacity: 1; } }

        /* setup */
        .stat-row { display: flex; align-items: center; margin-bottom: 15px; gap: 10px; }
        input[type=range] { flex: 1; accent-color: var(--primary); }

        /* game log */
        #log-container { flex: 1; overflow-y: auto; padding-bottom: 150px; scroll-behavior: smooth; }
        .log-item { padding: 10px 5px; border-bottom: 1px dashed rgba(0,0,0,0.05); font-size: 0.95rem; line-height: 1.6; animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .age-tag { background: var(--primary); color: white; padding: 2px 6px; border-radius: 4px; font-size: 0.75rem; margin-right: 8px; font-weight: bold; min-width: 35px; display: inline-block; text-align: center; }

        /* Interaction Area */
        #interaction-area {
            position: absolute; bottom: 0; left: 0; width: 100%;
            background: rgba(255,255,255,0.95);
            border-top: 1px solid #ddd;
            padding: 15px; box-sizing: border-box;
            display: none; flex-direction: column; gap: 10px;
            z-index: 20;
            box-shadow: 0 -5px 15px rgba(0,0,0,0.1);
        }
        body.mode-horror #interaction-area { background: #222; border-color: #444; }

        .choice-btn {
            background: var(--card-bg); border: 2px solid var(--primary); color: var(--text-main);
            padding: 12px; border-radius: 8px; font-weight: bold; cursor: pointer; text-align: left;
            transition: 0.2s;
        }
        .choice-btn:active { background: var(--primary); color: white; }

        /* Popups */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); z-index: 100;
            display: none; justify-content: center; align-items: center;
        }
        .modal-box {
            background: white; padding: 25px; border-radius: 15px; width: 80%; max-width: 300px;
            text-align: center; border: 2px solid #e74c3c;
        }
        .modal-btn { margin-top: 15px; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; }
        .btn-yes { background: #e74c3c; color: white; }
        .btn-no { background: #ccc; color: #333; }

        /* Text Styles */
        .txt-xiuxian { font-family: "KaiTi"; color: #00695c; font-weight: bold; }
        .txt-dating { color: #d81b60; font-style: italic; }
        .txt-horror { color: #c0392b; font-family: 'Courier New', monospace; letter-spacing: -0.5px; text-shadow: 1px 0 0 #000; }
        .txt-cthulhu { color: #9b59b6; font-family: 'Courier New', monospace; text-shadow: 2px 2px 4px #000; }
        .highlight { background: rgba(255, 235, 59, 0.3); padding: 0 4px; }
        .die-text { color: white; background: #c0392b; padding: 5px; border-radius: 4px; display: block; margin-top: 5px; text-align: center; }

        /* Buttons */
        .main-btn { width: 100%; padding: 15px; background: var(--primary); color: white; border: none; border-radius: 50px; font-size: 1rem; margin-top: 20px; font-weight: bold; }

    </style>
</head>
<body>

<div id="vfx-layer"></div>

<div class="container">
    <div class="header">
        <span>ğŸ§</span> <span id="header-title">é«˜é›…äººç”Ÿæ¨¡æ‹Ÿå™¨</span> <span>ğŸ·</span>
    </div>

    <div id="screen-start" class="screen active start-screen" style="text-align: center;">
        <div style="font-size: 60px; margin: 30px 0;">ğŸ•´ï¸ğŸ²ğŸ‘ï¸</div>
        <h1>äººç”Ÿé‡å¼€ v4.0</h1>
        <p style="color: #666; font-size: 0.9rem;">æ–°å¢ï¼šä¿®ä»™/ä¹™æ¸¸/æ€ªè°ˆ/å…‹è‹é²/ç„å¹»</p>
        
        <div style="background: #fff3e0; padding: 15px; border-radius: 10px; margin: 20px 0; font-size: 0.85rem; text-align: left; border-left: 5px solid #e67e22;">
            <strong>âš ï¸ æ¸¸ç©è­¦å‘Šï¼š</strong><br>
            æœ¬ä½œåŒ…å«ä¸–ç•Œçº¿å˜åŠ¨ç³»ç»Ÿã€‚<br>
            éƒ¨åˆ†å†…å®¹æ¶‰åŠ<span style="color:#c0392b; font-weight:bold;">å¾®ææ€–ã€ç²¾ç¥æ±¡æŸ“</span>å…ƒç´ ã€‚<br>
            å¿ƒè„ç—…æ‚£è€…æˆ–èƒ†å°è€…è¯·åœ¨æç¤ºå‡ºç°æ—¶é€‰æ‹©â€œæ‹’ç»â€ã€‚
        </div>

        <button class="main-btn" onclick="goToSetup()">å¼€å§‹æŠ½å¡</button>
    </div>

    <div id="screen-setup" class="screen">
        <h2 style="text-align: center;">åˆ†é…å¤©èµ‹ (20ç‚¹)</h2>
        <div style="display: flex; justify-content: center; gap: 10px; margin-bottom: 20px;">
            <button class="choice-btn" style="text-align:center; flex:1;" onclick="setGender('ç”·')">ç”·</button>
            <button class="choice-btn" style="text-align:center; flex:1;" onclick="setGender('å¥³')">å¥³</button>
            <button class="choice-btn" style="text-align:center; flex:1;" onclick="setGender('???')">???</button>
        </div>
        
        <div style="text-align:center; margin-bottom:15px; font-weight:bold; color:var(--accent)">
            å‰©ä½™ç‚¹æ•°: <span id="points">20</span>
        </div>

        <div id="sliders"></div> <button class="main-btn" onclick="startGame()">å¯åŠ¨äººç”Ÿ</button>
    </div>

    <div id="screen-game" class="screen">
        <div id="log-container"></div>
        
        <div id="interaction-area"></div>
        
        <div id="restart-area" style="display:none; position:absolute; bottom:20px; left:0; width:100%; padding:0 20px; box-sizing: border-box;">
            <button class="main-btn" onclick="resetGame()">å†æ¬¡é‡å¼€</button>
        </div>
    </div>
</div>

<div id="warning-modal" class="modal-overlay">
    <div class="modal-box">
        <h3 style="color:#c0392b">âš ï¸ è­¦å‘Š</h3>
        <p id="warning-text">å‰æ–¹æ£€æµ‹åˆ°é«˜èƒ½ååº”ï¼ˆææ€–/æ‰SANå†…å®¹ï¼‰ã€‚<br>æ˜¯å¦ç»§ç»­ï¼Ÿ</p>
        <div style="display: flex; gap: 10px; justify-content: center;">
            <button class="modal-btn btn-no" onclick="resolveWarning(false)">æˆ‘æ€‚äº†</button>
            <button class="modal-btn btn-yes" onclick="resolveWarning(true)">æå¿«ç‚¹</button>
        </div>
    </div>
</div>

<script>
    // --- æ¸¸æˆæ•°æ® ---
    const STATS_CONFIG = [
        {k:'face', n:'é¢œå€¼'}, {k:'iq', n:'æ™ºå•†'}, {k:'body', n:'ä½“è´¨'}, {k:'money', n:'å®¶å¢ƒ'}, {k:'luck', n:'æ°”è¿'}
    ];
    let stats = { face:0, iq:0, body:0, money:0, luck:0 };
    let points = 20;
    let gender = 'ç”·';
    let species = 'äººç±»';
    
    // è¿è¡Œæ—¶çŠ¶æ€
    let age = 0;
    let isDead = false;
    let currentMode = 'normal'; // normal, xiuxian, dating, horror, cthulhu, fantasy
    let gameTimer = null;
    let pendingMode = null; // ç”¨äºå¼¹çª—ç¡®è®¤
    let timeSkipCounter = 0; // è®°å½•è·³è¿‡äº†å¤šå°‘å¹´

    // --- DOM Elements ---
    const dom = {
        screens: document.querySelectorAll('.screen'),
        points: document.getElementById('points'),
        sliders: document.getElementById('sliders'),
        log: document.getElementById('log-container'),
        interaction: document.getElementById('interaction-area'),
        restart: document.getElementById('restart-area'),
        modal: document.getElementById('warning-modal'),
        headerTitle: document.getElementById('header-title')
    };

    // --- åˆå§‹åŒ– ---
    function init() {
        dom.sliders.innerHTML = STATS_CONFIG.map(s => `
            <div class="stat-row">
                <span style="width:50px; font-weight:bold">${s.n}</span>
                <input type="range" min="0" max="10" value="0" data-key="${s.k}" oninput="updatePoints('${s.k}', this.value)">
                <span id="val-${s.k}" style="width:25px; text-align:right">0</span>
            </div>
        `).join('');
        switchScreen('screen-start');
    }

    // --- UI é€»è¾‘ ---
    function switchScreen(id) {
        dom.screens.forEach(s => s.classList.remove('active'));
        document.getElementById(id).classList.add('active');
    }

    function setGender(g) { gender = g; }

    function updatePoints(key, val) {
        val = parseInt(val);
        let used = 0;
        document.querySelectorAll('input[type=range]').forEach(i => {
            if (i.dataset.key !== key) used += parseInt(i.value);
        });
        if (used + val > 20) val = 20 - used;
        
        document.querySelector(`input[data-key="${key}"]`).value = val;
        document.getElementById(`val-${key}`).innerText = val;
        stats[key] = val;
        points = 20 - (used + val);
        dom.points.innerText = points;
        dom.points.style.color = points === 0 ? 'green' : '#d35400';
    }

    // --- æ ¸å¿ƒæ¸¸æˆå¾ªç¯ ---
    function startGame() {
        if (points > 0) return alert('å±æ€§ç‚¹æ²¡åˆ†å®Œï¼');
        
        // é‡ç½®çŠ¶æ€
        age = -1; 
        isDead = false; 
        currentMode = 'normal';
        document.body.className = ''; 
        dom.log.innerHTML = '';
        dom.interaction.style.display = 'none';
        dom.restart.style.display = 'none';
        dom.headerTitle.innerText = "é«˜é›…äººç”Ÿæ¨¡æ‹Ÿå™¨";
        
        // ç¡®å®šç‰©ç§
        if (gender === '???') {
            const list = ['é«˜é›…ä¼é¹…', 'èµ›åšèŸ‘è‚', 'æ·±æµ·ç« é±¼', 'ä¸€æ£µæ ‘', 'å²è±å§†'];
            species = list[Math.floor(Math.random() * list.length)];
        } else {
            species = 'äººç±»';
        }

        switchScreen('screen-game');
        addLog(`<strong>ç³»ç»Ÿå¯åŠ¨</strong> | ç§æ—: ${species} | å±æ€§: ${JSON.stringify(stats).replace(/[{"}]/g,'')}`, 'normal');
        
        gameNextStep(); // å¯åŠ¨
    }

    function gameNextStep() {
        if (isDead) return;
        
        // 0.8ç§’ä¸€è·³
        gameTimer = setTimeout(() => {
            processYear();
        }, 800);
    }

    function processYear() {
        // 1. å¹´é¾„å¢é•¿é€»è¾‘ (ä¿®ä»™æ¨¡å¼è·³å¾—å¿«)
        let ageIncrement = 1;
        if (currentMode === 'xiuxian' && age > 20) ageIncrement = Math.floor(Math.random() * 10) + 5; 
        if (currentMode === 'xiuxian' && age > 200) ageIncrement = 50;
        
        age += ageIncrement;

        // 2. æ­»äº¡æ£€æµ‹ (éšæœºæš´æ¯™)
        if (checkDeath()) return;

        // 3. å°è¯•è§¦å‘ä¸–ç•Œçº¿å˜åŠ¨ (äººç±»ä¸”æ™®é€šæ¨¡å¼)
        if (currentMode === 'normal' && species === 'äººç±»' && age > 5 && Math.random() < 0.15) {
            tryTriggerWorldChange();
            return; // ç­‰å¾…ç”¨æˆ·é€‰æ‹©ï¼Œæš‚åœå¾ªç¯
        }

        // 4. ç”Ÿæˆå†…å®¹
        let eventData = generateEvent();
        
        // 5. æ™ºèƒ½è·³è¿‡é€»è¾‘
        if (!eventData) {
            timeSkipCounter += ageIncrement;
            // å¦‚æœè¿ç»­ç©ºçª—æœŸå¤ªé•¿ï¼Œæˆ–è€…ç´¯è®¡è·³è¿‡äº†ä¸€å®šå¹´ä»½ï¼Œæ‰æ˜¾ç¤º
            gameNextStep();
        } else {
            // å¦‚æœä¹‹å‰æœ‰è·³è¿‡ï¼Œå…ˆç»“ç®—
            if (timeSkipCounter > 0) {
                addLog(`...æ—¶å…‰é£é€ï¼Œè½¬çœ¼${timeSkipCounter}å¹´è¿‡å»äº†...`, 'skip');
                timeSkipCounter = 0;
            }
            addLog(eventData.text, currentMode, eventData.highlight);
            
            // 6. äº’åŠ¨æ£€æµ‹
            if (eventData.choices) {
                showChoices(eventData.choices);
            } else {
                gameNextStep();
            }
        }
    }

    // --- ä¸–ç•Œçº¿å˜åŠ¨ç³»ç»Ÿ ---
    function tryTriggerWorldChange() {
        const roll = Math.random();
        let targetMode = '';
        let desc = '';
        let isScary = false;

        // è§¦å‘æ¡ä»¶åˆ¤æ–­
        if (roll < 0.25 && (stats.iq > 7 || stats.body > 7)) {
            targetMode = 'xiuxian'; desc = 'ä½ åœ¨åœ°æ‘Šä¸Šçœ‹åˆ°ä¸€æœ¬å‘å…‰çš„ã€Šå¹¿æ’­ä½“æ“ã€‹ï¼Œä¼¼ä¹æ˜¯ä¿®ä»™ç§˜ç±ã€‚';
        } else if (roll < 0.5 && (stats.face > 7 || stats.luck > 8)) {
            targetMode = 'dating'; desc = 'è½¬è§’æ’åˆ°äº†ä¸€ä¸ªå˜´é‡Œå¼ç€é¢åŒ…çš„ç¾å°‘å¥³/å°‘å¹´ï¼Œç”»é£çªç„¶å˜æˆäº†ç²‰è‰²ã€‚';
        } else if (roll < 0.7) {
            targetMode = 'fantasy'; desc = 'ä½ æ‰“å¼€è¡£æŸœï¼Œå‘ç°åé¢é€šå‘ä¸€ä¸ªå……æ»¡é­”æ³•çš„ä¸–ç•Œã€‚';
        } else if (roll < 0.85) {
            targetMode = 'horror'; desc = 'å‘¨å›´å˜å¾—æ­»å¯‚ï¼Œé•œå­é‡Œçš„ä½ æ²¡æœ‰è·Ÿç€åŠ¨... (å¾®æ)'; isScary = true;
        } else {
            targetMode = 'cthulhu'; desc = 'å¤©ä¸Šçš„äº‘å˜æˆäº†è§¦æ‰‹çŠ¶ï¼Œä½ çš„SANå€¼å¼€å§‹ç‹‚æ‰... (æ‰SAN)'; isScary = true;
        }

        if (!targetMode) { gameNextStep(); return; } // æ¡ä»¶ä¸æ»¡è¶³å›é€€

        pendingMode = targetMode;

        if (isScary) {
            dom.warningText.innerHTML = `${desc}<br>åŒ…å«ææ€–/ç²¾ç¥æ±¡æŸ“å†…å®¹ï¼Œæ˜¯å¦è¿›å…¥ï¼Ÿ`;
            dom.modal.style.display = 'flex';
        } else {
            // éææ€–ç›´æ¥è¿›æˆ–ç»™ä¸ªç®€å•æç¤ºï¼ˆä¸ºäº†ç®€åŒ–ä»£ç ç›´æ¥è¿›ï¼Œæˆ–è€…ä¹Ÿå¯ä»¥åšé€‰é¡¹ï¼Œè¿™é‡Œç›´æ¥è¿›æ¨¡æ‹Ÿäº’åŠ¨ï¼‰
            changeMode(targetMode);
        }
    }

    function resolveWarning(accepted) {
        dom.modal.style.display = 'none';
        if (accepted) {
            changeMode(pendingMode);
        } else {
            addLog("ä½ æ„Ÿåˆ°ä¸€é˜µæ¶å¯’ï¼Œå†³å®šå…³ä¸Šé—¨å›å®¶ç¡è§‰ï¼Œæ‹’ç»äº†å‘½è¿çš„å¬å”¤ã€‚", 'normal');
            gameNextStep();
        }
    }

    function changeMode(mode) {
        currentMode = mode;
        document.body.className = `mode-${mode}`;
        
        let title = "é«˜é›…æ¨¡æ‹Ÿå™¨";
        if (mode === 'xiuxian') title = "ä¿®ä»™æ¨¡æ‹Ÿå™¨ (ç‚¼æ°”æœŸ)";
        if (mode === 'dating') title = "æ‹çˆ±å…»æˆæ¨¡æ‹Ÿå™¨";
        if (mode === 'horror') title = "è§„åˆ™æ€ªè°ˆæ¨¡æ‹Ÿå™¨";
        if (mode === 'cthulhu') title = "å…‹è‹é²çš„å‘¼å”¤";
        if (mode === 'fantasy') title = "å¼‚ç•Œå†’é™©ä¼ ";
        
        dom.headerTitle.innerText = title;
        addLog(`>>> ä¸–ç•Œçº¿å˜åŠ¨ï¼è¿›å…¥ã€${title}ã€‘ <<<`, mode, true);
        
        // æ¨¡å¼è¿›å…¥ç‰¹æ•ˆåç»§ç»­
        setTimeout(gameNextStep, 1000);
    }

    // --- å†…å®¹ç”Ÿæˆå¼•æ“ (The Story Engine) ---
    function generateEvent() {
        // A. ç‰¹æ®Šç‰©ç§å¤„ç†
        if (currentMode === 'normal' && species !== 'äººç±»') {
            if (Math.random() < 0.3) return { text: getSpeciesEvent() };
            return null; // è·³è¿‡
        }

        // B. æ¨¡å¼åˆ†æ”¯
        if (currentMode === 'xiuxian') return getXiuxianEvent();
        if (currentMode === 'dating') return getDatingEvent();
        if (currentMode === 'horror') return getHorrorEvent();
        if (currentMode === 'cthulhu') return getCthulhuEvent();
        if (currentMode === 'fantasy') return getFantasyEvent();

        // C. æ™®é€šäººç±»
        if (Math.random() < 0.3) {
            const evts = [
                "æ²‰è¿·çŸ­è§†é¢‘ï¼Œè§†åŠ›ä¸‹é™ã€‚", "åœ¨è·¯è¾¹æ¡åˆ°5å—é’±ã€‚", "è¯•å›¾å€’ç«‹æ´—å¤´å¤±è´¥ã€‚", 
                "å­¦ç‹—å«è¢«é‚»å±…æŠ•è¯‰ã€‚", "åšäº†ä¸€é¡¿é»‘æš—æ–™ç†ã€‚", "çœ‹äº†ä¸€æ•´å¤©çš„é«˜é›…è‰ºæœ¯å±•ï¼ˆå…¶å®æ²¡çœ‹æ‡‚ï¼‰ã€‚"
            ];
            return { text: evts[Math.floor(Math.random() * evts.length)] };
        }
        return null;
    }

    // --- 1. ä¿®ä»™æ¨¡å— (åƒå²è·¨åº¦) ---
    function getXiuxianEvent() {
        // äº’åŠ¨äº‹ä»¶
        if (Math.random() < 0.1) {
            return {
                text: "ä½ åœ¨ç§˜å¢ƒä¸­å‘ç°ä¸€æ ªã€ä¸ƒå½©ç‰ç’ƒè‰ã€‘ï¼Œä½†æ—è¾¹æœ‰ä¸€å¤´å®ˆæŠ¤å…½æ­£åœ¨ç¡è§‰ã€‚",
                highlight: true,
                choices: [
                    { txt: "å·äº†å°±è·‘", action: () => { 
                        if(stats.luck>5) resolveChoice("ä½ è¿æ°”çˆ†æ£šï¼ŒæˆåŠŸå·èµ°ä»™è‰ï¼Œä¿®ä¸ºå¤§æ¶¨ï¼", {iq:2, body:5});
                        else die("å®ˆæŠ¤å…½é†’äº†ï¼ŒæŠŠä½ å½“æˆäº†ç‚¹å¿ƒã€‚");
                    }},
                    { txt: "æ­£é¢ç¡¬åˆš", action: () => {
                         if(stats.body>8) resolveChoice("ä½ ä¸€æ‹³æ‰“çˆ†äº†å®ˆæŠ¤å…½ï¼Œéœ‡æƒŠç™¾é‡Œã€‚", {body:5, money:10});
                         else die("ä½ é«˜ä¼°äº†è‡ªå·±çš„å®åŠ›ï¼Œè¢«æ‹æˆäº†è‚‰æ³¥ã€‚");
                    }},
                    { txt: "æ‚„æ‚„ç¦»å¼€", action: () => resolveChoice("ç¨³å¥æ‰æ˜¯ä¿®ä»™å¤§è®¡ï¼Œä½ è‹Ÿä½äº†æ€§å‘½ã€‚", {luck:1}) }
                ]
            };
        }
        // æ™®é€šå‰§æƒ…
        const levels = ['ç‚¼æ°”', 'ç­‘åŸº', 'é‡‘ä¸¹', 'å…ƒå©´', 'åŒ–ç¥', 'æ¸¡åŠ«'];
        const lvl = levels[Math.min(5, Math.floor(age/100))];
        const plots = [
            `é—­å…³ä¿®ç‚¼${age%10+10}å¹´ï¼Œå¢ƒç•Œç¨³å›ºåœ¨${lvl}æœŸã€‚`,
            "å‚åŠ å®—é—¨å¤§æ¯”ï¼Œè™½ç„¶ç¬¬ä¸€è½®å°±è¢«æ·˜æ±°ï¼Œä½†ä½ å§¿åŠ¿å¾ˆå¸…ã€‚",
            "è·¯è¿‡å‡¡é—´ï¼Œå‘ç°å½“å¹´çš„ç‹æœå·²ç»è¦†ç­äº†ä¸‰æ¬¡ã€‚",
            "å°è¯•ç‚¼ä¸¹ï¼Œç‚¸æ¯äº†ä¸‰åº§å±±å¤´ã€‚",
            "è¢«é€€å©šçš„å¸ˆå¦¹å¦‚ä»Šå·²æ˜¯ä¸€æ–¹å¤§ä½¬ï¼Œä½ ç‘Ÿç‘Ÿå‘æŠ–ã€‚"
        ];
        return { text: `[${lvl}] ${plots[Math.floor(Math.random()*plots.length)]}` };
    }

    // --- 2. æ‹çˆ±æ¨¡å— (Galgame) ---
    function getDatingEvent() {
        if (Math.random() < 0.2) {
            return {
                text: "æ ¡èŠ±/æ ¡è‰æŠŠä½ å µåœ¨å¢™è§’ï¼š'æˆ‘æƒ³ï¼Œæˆ‘ä»¬ä¹‹é—´æ˜¯ä¸æ˜¯æœ‰ä»€ä¹ˆè¯¯ä¼šï¼Ÿ'",
                highlight: true,
                choices: [
                    { txt: "å£å’šå›å»", action: () => {
                        if(stats.face>8) resolveChoice("å¯¹æ–¹è„¸çº¢äº†ï¼Œå¥½æ„Ÿåº¦+100ã€‚", {luck:2});
                        else resolveChoice("å¯¹æ–¹æŠ¥äº†è­¦ï¼Œè¯´ä½ éªšæ‰°ã€‚", {money:-2});
                    }},
                    { txt: "å†·æ¼ èµ°å¼€", action: () => resolveChoice("å¯¹æ–¹è§‰å¾—ä½ çœŸæ˜¯ä¸ªæœ‰è¶£çš„ç”·äºº/å¥³äººï¼Œå¼•èµ·äº†æ³¨æ„ã€‚", {luck:1}) },
                    { txt: "å¤§å–Šæ•‘å‘½", action: () => resolveChoice("å…¨æ ¡éƒ½çŸ¥é“ä½ æ˜¯ä¸ªæ€‚åŒ…ï¼Œæ³¨å­¤ç”Ÿã€‚", {face:-2}) }
                ]
            };
        }
        const plots = [
            "æ”¶åˆ°äº†åŒ¿åçš„æƒ…ä¹¦ï¼Œå­—è¿¹å¾ˆä¸‘ã€‚", "åœ¨å¤©å°ä¸€èµ·åƒä¾¿å½“ï¼Œé£å¾ˆå¤§ï¼Œå‘å‹ä¹±äº†ã€‚", 
            "å› ä¸ºçœ‹é”™äº†äººï¼Œå¯¹ç€æ•™å¯¼ä¸»ä»»æ·±æƒ…å‘Šç™½ã€‚", "é›¨å¤©æ²¡å¸¦ä¼ï¼ŒæœŸå¾…çš„å…±ä¼æƒ…èŠ‚æ²¡æœ‰å‘ç”Ÿï¼Œæ·‹æˆäº†è½æ±¤é¸¡ã€‚"
        ];
        return { text: plots[Math.floor(Math.random()*plots.length)] };
    }

    // --- 3. è§„åˆ™æ€ªè°ˆ (ææ€–) ---
    function getHorrorEvent() {
        if (Math.random() < 0.2) {
            return {
                text: "ä½ åœ¨æ¡Œä¸Šå‘ç°ä¸€å¼ çº¸æ¡ï¼šã€è§„åˆ™3ï¼šä¸è¦ç»™æ•²é—¨çš„äººå¼€é—¨ï¼Œé™¤éä»–ç©¿ç€çº¢è¡£æœã€‘ã€‚æ­¤æ—¶ï¼Œæ•²é—¨å£°å“èµ·ã€‚",highlight: true,
                choices: [
                    { txt: "é€šè¿‡çŒ«çœ¼çœ‹é¢œè‰²", action: () => die("çŒ«çœ¼å¤–æ˜¯ä¸€åªè¡€çº¢çš„çœ¼ç›ï¼Œå®ƒä¹Ÿåœ¨çœ‹ä½ ã€‚ä½ æ­»äº†ã€‚") },
                    { txt: "ç›´æ¥å¼€é—¨", action: () => die("é—¨å¤–ä¹Ÿæ˜¯ä½ è‡ªå·±ã€‚ä½ è¢«æ›¿ä»£äº†ã€‚") },
                    { txt: "è£…ä¸åœ¨å®¶", action: () => resolveChoice("æ•²é—¨å£°æŒç»­äº†ä¸€æ•´å¤œï¼Œä½ ç²¾ç¥è¡°å¼±ï¼Œä½†æ´»ä¸‹æ¥äº†ã€‚", {body:-1, iq:1}) }
                ]
            };
        }
        const plots = [
            "å®¶é‡Œçš„é•œå­å¤šäº†ä¸€é¢ï¼Œä½ è®°å¾—ä½ æ²¡ä¹°è¿‡ã€‚", "åŠå¤œå¬åˆ°å¨æˆ¿æœ‰å’€åš¼å£°ï¼Œä½ å®¶æ˜æ˜æ²¡æœ‰å® ç‰©ã€‚",
            "æ‰‹æœºæ”¶åˆ°æœªæ¥çš„çŸ­ä¿¡ï¼š'åˆ«å›å¤´'ã€‚", "èµ°æ¥¼æ¢¯æ—¶ï¼Œå‘ç°å¤šäº†ä¸€çº§å°é˜¶ã€‚"
        ];
        return { text: plots[Math.floor(Math.random()*plots.length)] };
    }

    // --- 4. å…‹è‹é² (æ‰SAN) ---
    function getCthulhuEvent() {
        if (Math.random() < 0.2) {
            return {
                text: "ä½ æ¡åˆ°ä¸€æœ¬ç”¨äººçš®è£…è®¢çš„ä¹¦ï¼Œæ–‡å­—åœ¨è •åŠ¨ã€‚",
                highlight: true,
                choices: [
                    { txt: "é˜…è¯»", action: () => {
                        if(stats.iq > 9) resolveChoice("ä½ ç†è§£äº†å®‡å®™çš„çœŸç†ï¼Œå¹¶ç–¯äº†ã€‚", {iq:10}); 
                        else die("ä½ çš„è„‘æµ†æ²¸è…¾äº†ã€‚");
                    }},
                    { txt: "çƒ§æ‰", action: () => resolveChoice("ä¹¦å‘å‡ºå°–å«å£°åŒ–ä¸ºç°çƒ¬ï¼Œä½ é—»åˆ°äº†æµ·è…¥å‘³ã€‚", {luck:-1}) }
                ]
            };
        }
        const plots = [
            "é‚»å±…çš„è„¸å¶å°”ä¼šå˜æˆç« é±¼ã€‚", "ä½ æ¢¦è§äº†ä¸€åº§æ·±æµ·é‡Œçš„åŸå¸‚ï¼Œé†’æ¥æ—¶æµ‘èº«æ¹¿é€ã€‚", 
            "ä½ è§‰å¾—ä½ çš„å·¦æ‰‹æœ‰äº†è‡ªå·±çš„æ„è¯†ã€‚", "å¤©ä¸Šçš„æœˆäº®çå¼€äº†ä¸€åªçœ¼ç›ã€‚"
        ];
        return { text: plots[Math.floor(Math.random()*plots.length)] };
    }

    // --- 5. ç„å¹» (é­”æ³•) ---
    function getFantasyEvent() {
         if (Math.random() < 0.2) {
            return {
                text: "æ¶é¾™æŠ“èµ°äº†å…¬ä¸»ï¼Œå›½ç‹æ‚¬èµå‹‡è€…ã€‚",
                highlight: true,
                choices: [
                    { txt: "å»æ•‘å…¬ä¸»", action: () => die("ä½ è¢«æ¶é¾™ä¸€å£å–·æ­»äº†ã€‚") },
                    { txt: "å»æ•‘æ¶é¾™", action: () => resolveChoice("æ¶é¾™æ˜¯ä¸ªå¦¹å­ï¼Œä½ ä»¬è¿‡ä¸Šäº†å¹¸ç¦çš„ç”Ÿæ´»ã€‚", {luck:5}) },
                    { txt: "æˆ‘æ˜¯åæ´¾", action: () => resolveChoice("ä½ åŠ å…¥äº†æ¶é¾™é˜µè¥ï¼Œç“œåˆ†äº†è´¢å®ã€‚", {money:10}) }
                ]
            };
        }
        return { text: "ä½ å­¦ä¹ äº†ä¸€ä¸ªç«çƒæœ¯ï¼Œç”¨æ¥ç‚¹çƒŸå¾ˆæ–¹ä¾¿ã€‚" };
    }

    // --- ç‰©ç§ä¸“å± ---
    function getSpeciesEvent() {
        const events = {
            'é«˜é›…ä¼é¹…': ["ä¼˜é›…åœ°åƒäº†ä¸€åªç£·è™¾ã€‚", "åœ¨å—æä¸¾åŠäº†çº¢é…’å“é‰´ä¼šã€‚", "è¢«åšæˆäº†è¡¨æƒ…åŒ…ã€‚"],
            'èµ›åšèŸ‘è‚': ["åå™¬äº†ä¸€å—èŠ¯ç‰‡ï¼Œæ™ºåŠ›+1ã€‚", "èº²è¿‡äº†æ€è™«å‰‚çš„æ¯’é›¾ã€‚", "è¿æ¥ä¸Šäº†äººç±»çš„ç½‘ç»œã€‚"],
            'ä¸€æ£µæ ‘': ["å…‰åˆä½œç”¨ä¸­...", "ä¸€åªç‹—åœ¨ä½ è„šä¸‹æ’’å°¿ã€‚", "è¢«åˆ»äº†'åˆ°æ­¤ä¸€æ¸¸'ã€‚"]
        };
        const list = events[species] || ["æ­£åœ¨åŠªåŠ›ç”Ÿå­˜..."];
        return list[Math.floor(Math.random() * list.length)];
    }

    // --- æ ¸å¿ƒè¾…åŠ©åŠŸèƒ½ ---

    function showChoices(choices) {
        dom.interaction.innerHTML = '';
        dom.interaction.style.display = 'flex';
        
        choices.forEach(c => {
            const btn = document.createElement('button');
            btn.className = 'choice-btn';
            btn.innerText = `â¤ ${c.txt}`;
            btn.onclick = () => {
                dom.interaction.style.display = 'none';
                c.action();
            };
            dom.interaction.appendChild(btn);
        });
    }

    function resolveChoice(resultText, statChanges) {
        addLog(`ã€ç»“æœã€‘${resultText}`, currentMode, true);
        if (statChanges) {
            for(let k in statChanges) stats[k] += statChanges[k];
        }
        gameNextStep();
    }

    function checkDeath() {
        // ææ€–å’Œå…‹è‹é²æ¨¡å¼æå…¶å®¹æ˜“æ­»
        let baseRate = 0.002;
        if (currentMode === 'horror' || currentMode === 'cthulhu') baseRate = 0.05;
        if (currentMode === 'xiuxian' && age % 100 === 0) baseRate = 0.1; // æ¸¡åŠ«
        
        if (Math.random() < baseRate) {
            die("é­é‡ä¸å¯æŠ—åŠ›ï¼Œä½ çš„ç”Ÿå‘½æˆ›ç„¶è€Œæ­¢ã€‚");
            return true;
        }
        if (age > 1000) { die("å¯¿å…ƒè€—å°½ï¼Œé‡å…¥è½®å›ã€‚"); return true; }
        return false;
    }

    function die(reason) {
        isDead = true;
        clearTimeout(gameTimer);
        const div = document.createElement('div');
        div.className = 'log-item';
        div.innerHTML = `<span class="die-text">ğŸ’€ æ­»äº¡ï¼š${reason}</span>`;
        dom.log.appendChild(div);
        dom.log.scrollTop = dom.log.scrollHeight;
        dom.restart.style.display = 'block';
    }

    function addLog(text, mode, highlight) {
        const div = document.createElement('div');
        div.className = `log-item txt-${mode} ${highlight ? 'highlight' : ''}`;
        
        let ageLabel = age >= 0 ? `${age}å²` : 'ç³»ç»Ÿ';
        if (timeSkipCounter > 0 && text.includes('æ—¶å…‰é£é€')) ageLabel = '...';

        div.innerHTML = `<span class="age-tag">${ageLabel}</span> ${text}`;
        dom.log.appendChild(div);
        dom.log.scrollTop = dom.log.scrollHeight;
    }

    function resetGame() {
        switchScreen('screen-start');
        init(); // é‡ç½®UI
    }

    // Run
    init();

</script>
</body>
</html>
       